#!/usr/bin/env node

const path = require('path');
const fse = require('fs-extra');
const opn = require('opn');
const program = require('commander');
const serve = require('../lib/serve');

program
  .option('-c, --config [config]', '配置文件', 'mese.config.js')
  .option('-s, --static-dir [staticDir]', '存放构建结果的目录', 'dist')
  .option('-p, --port [port]', '设置端口号', 3000)
  .option('-o, --open', '自动打开首页')
  .parse(process.argv);

const cwd = process.cwd();
const meseUrl = path.join(cwd, program.config);
const staticDir = path.join(cwd, program.staticDir);
const port = program.port;
const open = program.open;
const index = getIndex();
const manifest = getManifest();
serve({
  index,
  manifest,
  staticDir,
  port,
  callback() {
    open && opn(`http://localhost:${port}`);
    console.log(`[Mese] Listening on port ${port}`);
  }
});

/**
 * 获取首页的名称字符串
 * @returns {String} 首页文件的名称
 */
function getIndex() {
  if (!fse.pathExistsSync(meseUrl)) {
    console.log('[Mese] mess.js not found.');
    process.exit(-1);
  }
  const pages = require(meseUrl).pages;
  if (!pages) {
    console.log('[Mese] pages not found.');
    process.exit(-1);
  }
  return path.parse(pages[0]).name;
}

/**
 * 获取manifest.json的内容
 * @returns {Object} manifest.json的内容
 */
function getManifest() {
  const url = path.join(staticDir, 'manifest.json');
  if (!fse.pathExistsSync(url)) {
    console.log('[Mese] manifest.json not found.');
    process.exit(-1);
  }
  return require(url);
}